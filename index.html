
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Ride Guardian</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root {
            --primary: #00ff88;
            --danger: #ff4757;
            --bg: #1e1e24;
            --card-bg: #2b2b36;
            --text: #ffffff;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        
        body { background-color: var(--bg); color: var(--text); overflow-x: hidden; }

        /* --- LOGIN SCREEN --- */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 1000; display: flex;
            justify-content: center; align-items: center; flex-direction: column;
        }
        
        .login-box {
            background: var(--card-bg); padding: 2rem; border-radius: 15px;
            width: 90%; max-width: 400px; text-align: center;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }

        input {
            width: 100%; padding: 12px; margin: 10px 0; border: none;
            border-radius: 5px; background: #3a3a45; color: white;
        }

        button {
            width: 100%; padding: 12px; border: none; border-radius: 5px;
            cursor: pointer; font-weight: bold; transition: 0.3s;
        }

        .btn-primary { background: var(--primary); color: #000; }
        .btn-danger { background: var(--danger); color: white; animation: pulse 2s infinite; }

        /* --- DASHBOARD --- */
        #dashboard { display: none; padding-bottom: 80px; }
        
        header {
            padding: 15px; display: flex; justify-content: space-between; align-items: center;
            background: var(--card-bg); border-bottom: 2px solid var(--primary);
        }

        .status-badge {
            padding: 5px 10px; border-radius: 20px; font-size: 0.8rem;
            background: #444; color: #aaa;
        }
        .status-badge.active { background: var(--primary); color: #000; }

        /* MAP AREA */
        #map { height: 350px; width: 100%; z-index: 1; }

        /* GRID STATS */
        .stats-grid {
            display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; padding: 15px;
        }
.speedometer{
  position: fixed;
  color: #000;
  bottom: 20px;
  left: 20px;
  width: 90px;
  height: 90px;
  background: white;
  border-radius: 50%;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  box-shadow: 0 4px 10px rgba(0,0,0,0.3);
}

.speed{
  font-size: 28px;
  font-weight: bold;
}

.unit{
  font-size: 14px;
  color: gray;
}

        .card {
            background: var(--card-bg); padding: 15px; border-radius: 10px;
            text-align: center; padding: 20px;
        }

        .card i { font-size: 1.5rem; margin-bottom: 10px; color: var(--primary); }
        .data-value { font-size: 1.5rem; font-weight: bold; }
        .data-unit { font-size: 0.8rem; color: #888; }

        /* SETTINGS & SOS */
        .controls { padding: 15px; }
        
        /* CONNECTION MODAL */
        #connect-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 2000;
            justify-content: center; align-items: center;
        }

        .modal-content {
            background: var(--card-bg); padding: 20px; border-radius: 10px; width: 80%;
            text-align: center;
        }

        .connect-opt {
            display: block; width: 100%; margin: 10px 0; padding: 15px;
            background: #333; color: white; border: 1px solid #555;
        }

        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-box">
            <h2><i class="fas fa-shield-alt"></i> Smart Road Guardian</h2>
            <p style="color:#aaa; margin-bottom: 20px;">IoT Biometric & Road Safety</p>
            <input type="text" placeholder="Username" id="username">
            <input type="password" placeholder="Password" id="password">
            <button class="btn-primary" onclick="handleLogin()">Login Securely</button>
        </div>
    </div>
<div class="speedometer">
  <div class="speed" id="speed">0</div>
  <div class="unit">km/h</div>
</div>
    <div id="dashboard">
        <header>
            <div class="user-info">
                <h3>Hi, <span id="display-name">User</span></h3>
                <span id="connection-status" class="status-badge">Disconnected</span>
            </div>
            <button onclick="showConnectModal()" style="width: auto; padding: 8px 15px; background: #333; color: white;">
                <i class="fas fa-plug"></i> Connect
            </button>
        </header>

        <div id="map"></div>

        <div class="controls">
            <button class="btn-danger" onclick="triggerSOS()">
                <i class="fas fa-exclamation-triangle"></i> SOS / ACCIDENT ALERT
            </button>
        </div>

        <div class="stats-grid">
            <div class="card">
                <i class="fas fa-heartbeat" style="color: #ff4757;"></i>
                <div class="data-value" id="bpm-display">--</div>
                <div class="data-unit">BPM</div>
            </div>
            <div class="card">
                <i class="fas fa-wind" style="color: #00d2d3;"></i>
                <div class="data-value" id="aqi-display">--</div>
                <div class="data-unit">Air Quality (AQI)</div>
            </div>
            <div class="card">
                <i class="fas fa-eye" id="eye-icon"></i>
                <div class="data-value" id="drowsy-status">Awake</div>
                <div class="data-unit">Driver Status</div>
            </div>
            <div class="card">
                <i class="fas fa-road" style="color: #feca57;"></i>
                <div class="data-value" id="pothole-count">0</div>
                <div class="data-unit">Potholes Detected</div>
            </div>
        </div>

        <div class="controls">
            <h3><i class="fas fa-cog"></i> Settings</h3>
            <label>Emergency Number:</label>
            <input type="tel" id="emergency-contact" value="112" placeholder="Enter SOS Number">
            <button class="btn-primary" onclick="alert('Emergency Contact Saved!')">Save Number</button>
        </div>
    </div>

    <div id="connect-modal">
        <div class="modal-content">
            <h3>Select Connection Method</h3>
            <button class="connect-opt" onclick="connectDevice('bluetooth')"><i class="fab fa-bluetooth"></i> Bluetooth</button>
            <button class="connect-opt" onclick="connectDevice('wifi')"><i class="fas fa-wifi"></i> Wi-Fi (IP)</button>
            <button class="connect-opt" onclick="closeModal()" style="background: transparent; border: none; color: #888;">Cancel</button>
        </div>
    </div>

    <script>
        // --- VARIABLES ---
        let map, userMarker;
        let emergencyNumber = "112";
        let isConnected = false;
        let deviceType = null;
        let deviceIP = null;
        
        // --- INITIALIZATION ---
        function initMap() {
            // Default to India coordinates (approx)
            map = L.map('map').setView([20.5937, 78.9629], 5);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; OpenStreetMap contributors'
            }).addTo(map);

            // Try to get real location
            if (navigator.geolocation) {
                navigator.geolocation.watchPosition(updateLocation, error => console.log(error), {
                    enableHighAccuracy: true
                });
            }
        }
if ("geolocation" in navigator) {
  navigator.geolocation.watchPosition(
    (position) => {
      let speed = position.coords.speed; // meters per second

      if (speed === null) speed = 0;

      // Convert m/s to km/h
      let speedKmh = (speed * 3.6).toFixed(0);

      document.getElementById("speed").innerText = speedKmh;
    },
    (error) => {
      console.error(error);
      alert("Please enable GPS & location permission");
    },
    {
      enableHighAccuracy: true,
      maximumAge: 0,
      timeout: 5000
    }
  );
} else {
  alert("Geolocation not supported in this browser.");
}

        function updateLocation(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            if (!userMarker) {
                userMarker = L.marker([lat, lng]).addTo(map).bindPopup("You are here").openPopup();
                map.setView([lat, lng], 15);
            } else {
                userMarker.setLatLng([lat, lng]);
            }
        }

        // --- LOGIN LOGIC ---
        function handleLogin() {
            const user = document.getElementById('username').value;
            if(user) {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                document.getElementById('display-name').innerText = user;
                initMap(); // Load map only after login
            } else {
                alert("Please enter a username");
            }
        }

        // --- CONNECTION LOGIC ---
        function showConnectModal() {
            document.getElementById('connect-modal').style.flex = 'flex';
            document.getElementById('connect-modal').style.display = 'flex';
        }
        function closeModal() {
            document.getElementById('connect-modal').style.display = 'none';
        }

        // async function connectDevice(type) {
        //     closeModal();
        //     const statusEl = document.getElementById('connection-status');
            
        //     if (type === 'bluetooth') {
        //         try {
        //             // REAL WEB BLUETOOTH API CALL (Commented out for safety/demo)
                    
        //             const device = await navigator.bluetooth.requestDevice({
        //                 acceptAllDevices: true,
        //                 optionalServices: ['battery_service'] // Add your custom UUIDs here
        //             });
        //             await device.gatt.connect();
                    
                    
        //             alert("Scanning for Bluetooth devices... (Simulation Mode Active)");
        //             statusEl.innerText = "BT Connected";
        //             statusEl.classList.add('active');
        //             isConnected = true;

        //         } catch (error) {
        //             alert("Bluetooth Error: " + error);
        //         }
        //     } else {
        //         let ip = prompt("Enter Device IP Address (e.g., 192.168.4.1):");
        //         if (ip) {
        //             statusEl.innerText = "WiFi Connected";
        //             statusEl.classList.add('active');
        //             isConnected = true;

        //         }
        //     }
        // }
function setDisconnected() {
            isConnected = false;

            document.getElementById("connection-status").innerText = "Disconnected";

            document.getElementById("connection-status").classList.remove("active");

            document.getElementById("bpm-display").innerText = "--";

            document.getElementById("aqi-display").innerText = "--";

            document.getElementById("drowsy-status").innerText = "--";
        }
        async function connectBluetooth() {
  try {
    const device = await navigator.bluetooth.requestDevice({
      filters: [{ namePrefix: "ESP32" }],
      optionalServices: ['12345678-1234-1234-1234-1234567890ab']
    });

    const server = await device.gatt.connect();
    const service = await server.getPrimaryService(
      '12345678-1234-1234-1234-1234567890ab'
    );

    const characteristic = await service.getCharacteristic(
      'abcd1234-1234-1234-1234-abcdef123456'
    );

    await characteristic.startNotifications();
    characteristic.addEventListener('characteristicvaluechanged', handleBLEData);

    setConnected("BT Connected");

  } catch (e) {
    alert("Bluetooth connection failed");
    setDisconnected();
  }
}
function handleBLEData(event) {
  const value = new TextDecoder().decode(event.target.value);
  // Example: "BPM:78,AQI:45,SLEEP:0"
  const data = Object.fromEntries(
    value.split(',').map(v => v.split(':'))
  );

  document.getElementById("bpm-display").innerText = data.BPM;
  document.getElementById("aqi-display").innerText = data.AQI;
  document.getElementById("drowsy-status").innerText = data.SLEEP == 1 ? "Sleepy" : "Awake";
}
async function connectWiFi() {
  deviceIP = prompt("Enter ESP32 IP (e.g. 192.168.4.1)");
  if (!deviceIP) return;

  try {
    const res = await fetch(`http://${deviceIP}/data`);
    if (!res.ok) throw "ESP32 not responding";

    setConnected("WiFi Connected");

    setInterval(fetchESP32Data, 2000);

  } catch (e) {
    alert("Cannot connect to ESP32 over WiFi");
    setDisconnected();
  }
}

async function fetchESP32Data() {
  if (!isConnected) return;

  const res = await fetch(`http://${deviceIP}/data`);
  const data = await res.json();

  document.getElementById("bpm-display").innerText = data.bpm;
  document.getElementById("aqi-display").innerText = data.aqi;
  document.getElementById("drowsy-status").innerText = data.sleep ? "Sleepy" : "Awake";
}
     
function connectDevice(type) {
  closeModal();

  if (type === "bluetooth") {
    connectBluetooth();
  } else {
    connectWiFi();
  }
}
// Already have markPothole()
// Extend to send P2P alerts via WebSocket (simulation here)
let ws = new WebSocket('wss://yourserver.com'); // Replace with your P2P server

function markPothole() {
    if(userMarker) {
        const currentPos = userMarker.getLatLng();
        L.circle([currentPos.lat, currentPos.lng], {
            color: 'red',
            fillColor: '#f03',
            fillOpacity: 0.5,
            radius: 20
        }).addTo(map).bindPopup("Pothole Detected!");

        let count = document.getElementById('pothole-count');
        count.innerText = parseInt(count.innerText) + 1;

        // Send to P2P network
        const alertData = {
            lat: currentPos.lat,
            lng: currentPos.lng,
            timestamp: Date.now()
        };
        if(ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify(alertData));
    }
}

// Handle incoming alerts
ws.onmessage = function(event) {
    const data = JSON.parse(event.data);
    L.circle([data.lat, data.lng], {
        color: 'orange',
        fillColor: '#ffa500',
        fillOpacity: 0.3,
        radius: 20
    }).addTo(map).bindPopup("Nearby rider reported hazard!");
}
function checkFatigue() {
    const bpm = parseInt(document.getElementById('bpm-display').innerText);
    const drowsy = document.getElementById('drowsy-status').innerText;
    if(!isNaN(bpm) && (bpm > 120 || drowsy === "Sleepy")) {
        alert("Fatigue detected! Nearest rest stop / cafÃ© / hospital suggested.");
        // Example: open Google Maps nearby hospitals
        window.open(`https://www.google.com/maps/search/hospital+near+me/`, '_blank');
    }
}

// Call this every few seconds
setInterval(checkFatigue, 5000);

        
    function setConnected(text) {
     isConnected = true;
  const statusEl = document.getElementById("connection-status");
  statusEl.innerText = text;
  statusEl.classList.add("active");
}
  function markPothole() {
            if(userMarker) {
                const currentPos = userMarker.getLatLng();
                // Add a red circle for pothole
                L.circle([currentPos.lat, currentPos.lng], {
                    color: 'red',
                    fillColor: '#f03',
                    fillOpacity: 0.5,
                    radius: 20
                }).addTo(map).bindPopup("Pothole Detected!");
                
                let count = document.getElementById('pothole-count');
                count.innerText = parseInt(count.innerText) + 1;
            }
        }
function suggestLowPollutionRoute(currentLat, currentLng) {
    // Example logic: if AQI > 100, suggest nearby cleaner route
    const aqi = parseInt(document.getElementById('aqi-display').innerText);
    if(aqi > 100) {
        alert("High air pollution detected! Consider taking an alternative route.");
        // Here you could integrate Maps API routing for real implementation
    }
}

// Call this whenever AQI updates
function handleBLEData(event) {
    const value = new TextDecoder().decode(event.target.value);
    const data = Object.fromEntries(
        value.split(',').map(v => v.split(':'))
    );
    document.getElementById("bpm-display").innerText = data.BPM;
    document.getElementById("aqi-display").innerText = data.AQI;
    document.getElementById("drowsy-status").innerText = data.SLEEP == 1 ? "Sleepy" : "Awake";

    // Suggest low-pollution route
    if(userMarker) {
        const ll = userMarker.getLatLng();
        suggestLowPollutionRoute(ll.lat, ll.lng);
    }
}

        function triggerDrowsinessAlert() {
            const status = document.getElementById('drowsy-status');
            status.innerText = "SLEEP DETECTED!";
            status.style.color = "red";
            
            // Play Sound
            playBeep();
            
            setTimeout(() => {
                status.innerText = "Awake";
                status.style.color = "white";
            }, 5000);
        }
// --- VOICE ACTIVATED SOS ---
function initVoiceSOS() {
    if (!('webkitSpeechRecognition' in window || 'SpeechRecognition' in window)) {
        console.log("Voice recognition not supported");
        return;
    }

    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    const recognition = new SpeechRecognition();
    recognition.continuous = true;
    recognition.lang = 'en-US';

    recognition.onresult = function(event) {
        const transcript = event.results[event.results.length - 1][0].transcript.trim().toLowerCase();
        console.log("Heard:", transcript);
        if(transcript.includes("help")) {
            triggerSOS();
            alert("Voice SOS triggered!");
        }
    }

    recognition.onerror = function(e) { console.error("Voice error:", e); }

    recognition.start();
}

// Call this after dashboard loads
document.addEventListener('DOMContentLoaded', initVoiceSOS);

        function playBeep() {
            // Browser Audio API
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator();
            osc.type = 'square';
            osc.frequency.setValueAtTime(440, ctx.currentTime);
            osc.connect(ctx.destination);
            osc.start();
            osc.stop(ctx.currentTime + 1); // Beep for 1 second
            alert("WAKE UP! (Speaker Activated)");
        }

        function triggerSOS() {
            const num = document.getElementById('emergency-contact').value;
            // Get current location string
            let locString = "Unknown Location";
            if(userMarker) {
                const ll = userMarker.getLatLng();
                locString = `https://www.google.com/maps?q=${ll.lat},${ll.lng}`;
            }

            const message = `SOS! I have been in an accident. My location is: ${locString}`;
            
            // Open default SMS app
            window.open(`sms:${num}?body=${encodeURIComponent(message)}`, '_blank');
        }
    </script>
</body>
</html>
